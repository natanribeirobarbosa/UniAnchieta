<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa UniAnchieta</title>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAmsaehyPzmtmJr5Tvl0snt5wgsnnxw8Ps",
            authDomain: "unianchieta-a83bd.firebaseapp.com",
            databaseURL: "https://unianchieta-a83bd-default-rtdb.firebaseio.com",
            projectId: "unianchieta-a83bd",
            storageBucket: "unianchieta-a83bd.firebasestorage.app",
            messagingSenderId: "566413683292",
            appId: "1:566413683292:web:0b274aaf669269c7041499",
            measurementId: "G-G8DGTH92FJ"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Função para carregar todas as salas do Firestore
        async function carregarSalas() {
            const salasRef = collection(db, "salas");
            const snapshot = await getDocs(salasRef);

            const salas = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                salas.push(data);
                console.log(data);
                console.log(salas);
                // Exibe todas as informações da sala no console
// Adiciona as salas no array
            });

            return salas;
        }

        // Função para buscar na keyword e retornar resultados
      window.buscarDestino = async function() {
    const pesquisa = document.getElementById('pesquisa').value.trim().toLowerCase();
    const destinoMsg = document.getElementById('destinoMsg');
    const infoDetalhada = document.getElementById('infoDetalhada');

    destinoMsg.textContent = ''; // Limpar mensagens anteriores
    infoDetalhada.textContent = ''; // Limpar resultados anteriores

    if (pesquisa === '') {
        destinoMsg.textContent = 'Por favor, digite algo para pesquisar.';
        return;
    }

    try {
        const salas = await carregarSalas();  // Carrega as salas do Firestore
        let encontrouResultado = false;
        let resultadoCount = 0;  // Contador de resultados

        salas.forEach((data) => {
            const keywords = data.keywords || [];
            if (keywords.some(keyword => keyword.toLowerCase().includes(pesquisa))) {
                encontrouResultado = true;
                resultadoCount++;

                // Criar item de resultado
                const item = document.createElement("li");
                item.className = "cursor-pointer p-2 border-b hover:bg-gray-100";
                item.innerHTML = `
                    <strong>${data.predio} - ${data.andar} - Sala ${data.sala}</strong><br>
                    <span>${data.curso} | ${data.disciplina}</span><br>
                    <small>${data.docente} - ${data.horario}</small>
                `;

                // Adicionar evento de clique no item
                item.onclick = function() {
                    exibirDetalhes(data);
                };

                // Adicionar o item à lista de resultados
                infoDetalhada.appendChild(item);
            }
        });

        if (!encontrouResultado) {
            destinoMsg.textContent = 'Nenhum destino encontrado para a pesquisa.';
        }

    } catch (error) {
        console.error('Erro ao buscar destino:', error);
        destinoMsg.textContent = 'Erro ao buscar destino.';
    }
};

// Função para exibir detalhes de uma sala
function exibirDetalhes(data) {
    const infoDetalhada = document.getElementById('infoDetalhada');
    const infoRota = document.getElementById('infoRota');
    const infoAula = document.getElementById('infoAula');
    
    // Limpar a área de detalhes anteriores
    infoDetalhada.innerHTML = '';
    infoRota.innerHTML = '';
    infoAula.innerHTML = '';

    // Exibir as informações detalhadas sobre a sala
    infoRota.textContent = `Você está procurando pela sala: ${data.predio} - ${data.andar} - Sala ${data.sala}`;
    infoAula.innerHTML = `
        <strong>Curso:</strong> ${data.curso} <br>
        <strong>Disciplina:</strong> ${data.disciplina} <br>
        <strong>Docente:</strong> ${data.docente} <br>
        <strong>Horário:</strong> ${data.horario}
    `;

    // Mostrar como chegar no mapa
    const marker = new google.maps.Marker({
        position: { lat: data.latitude, lng: data.longitude },
        map: map,
        title: `${data.predio} - ${data.sala}`
    });

    // Centralizar o mapa na sala
    map.setCenter({ lat: data.latitude, lng: data.longitude });
    map.setZoom(18);

    // Instrução de como chegar
    const instrucao = document.createElement("p");
    instrucao.textContent = `A sala está localizada no ${data.predio}, ${data.andar}º andar.`;
    infoDetalhada.appendChild(instrucao);
};

    </script>

    <!-- Google Maps -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=SUA_CHAVE_API&callback=initMap"></script>

    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="flex flex-col items-center justify-center h-screen bg-gray-100">
    <div class="bg-white shadow-lg rounded-lg p-6 max-w-md w-full text-center">
        <h1 class="text-2xl font-bold mb-4">Sistema de Localização - UniAnchieta</h1>

        <!-- Pesquisa -->
        <input type="text" id="pesquisa" placeholder="Digite a sala, professor ou disciplina" class="border p-2 w-full rounded">
        <button onclick="buscarDestino()" class="bg-green-500 text-white px-4 py-2 rounded mt-2 w-full hover:bg-green-700">
            Buscar
        </button>
        <p id="destinoMsg" class="mt-2 text-red-500"></p>

        <!-- Informações detalhadas da sala -->
        <div id="infoDetalhada" class="mt-4 text-left text-gray-700"></div>

        <!-- Mapa -->
        <div id="map" class="mt-4 w-full h-64"></div>
    </div>
</body>

<script>
    let map;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.561, lng: -46.662 },
            zoom: 16
        });
    }

    // Carregar o mapa assim que a página for carregada
    window.onload = function() {
        initMap();
    };
</script>
</html>
